/*                                                                                                          

````````````````````````````````````````````````````````````````````````````````````````````````````
````````````````````````````````````````````````````````````````````````````````````````````````````
````````````````````````````````````````````````````````````````````````````````````````````````````
````````````````````````````````````````````````````````````````````````````````````````````````````
````````````````````````````````````````````````````````````````````````````````````````````````````
````````````````````````````````````````````````````````````````````````````````````````````````````
````````````````````````````````````````````````````````````````````````````````````````````````````
```````````````````````````.````````````````````````````````````````````````````````````````````````
``````````````````-.-:/:---s:::-----````````````````````````````````````````````````````````````````
``````````````````-os:+s.s/y:+y.s++y````````````````````````````````````````````````````````````````
```````````````````-..-.`:--..-`.-.-```````````````.-:+ossssso+:-.``````````````````````````````````
``````````````````:.:://:y:-:/.`---------```````-+ydmNNNNNNNNNNNmds:.```````````````````````````````
``````````````````.oo:+s-y//oo/`-::::::::````./ymNNNNNNNNNNNNNNNNNNmh/``````````````````````````````
```````````````````.....-...-..`````````````-yNNNNNNNNNNdmNNNNNNNNNNNNy-````````````````````````````
```````````````````````````````````````````:mNNNNNNNddm+.-dNNNNNNmsmNNNd:```````````````````````````
``````````````````````````````````````````-mNNNNNNNd.`.`  /NNNNNmo::ymNNm-``````````````````````````
`````````````````````````````````````````.hNNNNNNNNNs:.`  /NNNNmo/:--/hNNh``````````````````````````
`````````````````````````````````````````oNNNNNNNNNNNNNdy+dNNNdyso:---+yNN-`````````````````````````
````````````````````````````````````````:NNNNNNNNNNNNNNNNNNNms///+:-----hN:`````````````````````````
```````````````````````````````````````.dNNNNNNNNNNNNNNNNNmy///h+/:--:-oyN-`````````````````````````
```````````````````````````````````````yNNNNNNNNddNNNNNNmy+///+Ny/:--+ohhy``````````````````````````
``````````````````````````````````````/NNNNNNNNy/o+dNNds///////o+/:---h/:h``````````````````````````
`````````````````````````````````````-mNNNNNNNNo/h+/++////////////:---/y-y.`````````````````````````
````````````````````````````````````-dNNNNNNNNNd/syo//////////////:---++-y-`````````````````````````
``````````````````````````````````-smNNNNNNNNNNNmyo+++////////////:------y.`````````````````````````
```````````````````````````````-odNNNNNNNNNNNNNNNNNNNNs/////////osoooo---h``````````````````````````
`````````````````````````````-sNNNNNNNNNNNNNNNNNNNNNNNsy//////////:-----s:``````````````````````````
````````````````````````````+mNNNNNNNNNNNNNNNNNNNNNNNs//ss+///////:----o+```````````````````````````
```````````````````````````:NNNNNNNNNNNNNNNNNNNNNNNNy/////osso+///::/oo:````````````````````````````
```````````````````````````+NNNNNNNNNNNNNNNNNNNNNNNd//////////+hmms/-.``..-:/+osyh:`````````````````
```````````````````````````.mNNNNNNNNNNNNNNNNNNNNNd///////////oNNhosyhdmNNNMMMMMMM:`````````````````
````````````````````````````/mNNNNNNNNNNNNNNNNNNNmo+oosyhhdmNNMMMMMMMMNmdmMNo//mMM:`````````````````
`````````````````````````````+NNNNNNNNNNNNNNNMMMMNNNMMMMMMNNMMhysN/:-My.`.d/ `hMMM:`````````````````
``````````````````````````.-+dNNNMMMMMMMMMMMMMNNmMMNso+N-..:mm  `m  `NMh` ` `hMMMM:`````````````````
``````````````````````oyhdmNMMMMMMMNmmdhhdNMMo..`oMd  `N    -h  `m  `NMMd`  sMMMMM:`````````````````
``````````````````````dMMNdhhyooohM-.`.. `:Md  ` `hd  `N  `/ .  `m   so+:`  hMMMMM:`````````````````
``````````````````````dMMs.  .:  .M`  so  -N- .o  .h  `N  `No   `N`..-:/+osyNMMMMM:`````````````````
``````````````````````dMMN:  -:  +N`  `  .mo  `.`  -  .N..:MMyoyhMdmNNMMMMNNmmdhhy-`````````````````
``````````````````````dMMM/  :s.  y`  y-  /``:ddh/osyhdMmNNMMMMNNmmdhyso+/:--..`````````````````````
``````````````````````dMMd-  .-`./m:-/NmsyhdmNMMMMMNNmmdhyso+/::--..````````````````````````````````
``````````````````````dMMy/+oyhdmMMNMMMMNNmmdhyso+/::-..````````````````````````````````````````````
``````````````````````dMMMMMNNNmddhso+//:-..````````````````````````````````````````````````````````
``````````````````````syso+/:--..```````````````````````````````````````````````````````````````````
````````````````````````````````````````````````````````````````````````````````````````````````````
```````````````````````````````---.---::--.-:--:.-:-:.--:-:.----.---.```````````````````````````````
```````````````````````````````.--..--.--..--.--.-:.-.-----.:---.-.-.```````````````````````````````
``````````````````````````````````````-:/:-:/::://+-/:/://:+::``````````````````````````````````````
``````````````````````````````````````..````````````````````````````````````````````````````````````
````````````````````````````````````````````````````````````````````````````````````````````````````
````````````````````````````````````````````````````````````````````````````````````````````````````
````````````````````````````````````````````````````````````````````````````````````````````````````
                                                                                                                                                

*/
// author : Virdio Samuel | @virdiosam
const fs = require('fs');
const {
    Client
} = require('whatsapp-web.js');
const {
    MessageMedia
} = require('whatsapp-web.js');
const qrcode = require('qrcode-terminal');
const brainly = require('./brainly');
const cron = require('node-cron');
const Virdina = require('./lib/Virdina');
const colors = require('colors');
const Math_js = require('mathjs');

// Path where the session data will be stored
const SESSION_FILE_PATH = './session.json';

//Load the session data if it has been previously saved
let sessionData;
if (fs.existsSync(SESSION_FILE_PATH)) {
    sessionData = require(SESSION_FILE_PATH);
}

//Use the saved values
const client = new Client({
    session: sessionData
});


//Save session values to the file upon successful auth
client.on('authenticated', (session) => {
    sessionData = session;
    fs.writeFile(SESSION_FILE_PATH, JSON.stringify(session), function(err) {
        if (err) {
            console.error(err);
        }
    });
});

//qrcode
client.on('qr', (qr) => {
    console.log('QR RECEIVED');
    qrcode.generate(qr, {
        small: true
    });
});

//appear when bot is ready
client.on('ready', () => {
    console.log('Bot is ready!');
});

client.on('message', message => {
    //start
    Virdina.set(client, message);
    Virdina.startLog()
    Virdina.addPrefix('/');

    //  /brainly <pertanyaan> -<jumlah>
    Virdina.createCommand('brainly', function(msg, res) {
        var raw = res.split(/\s/)
        var amount = Number(raw[raw.length - 1].split('-')[1]) || 5
        if (Number(raw[raw.length - 1])) {raw.pop()}
        var question = raw.join(" ")

        /* 
          PERHATIAN, DISARANKAN BATAS JANGAN TERLALU BESAR 
          UNTUK MENGHINDARI DIBANNEDNYA NOMOR (KARENA SPAM)
          ATUR BATAS MAKSIMAL JAWABAN DISINI
        */
        const BATAS = 10
        const urlQuestion = "https://brainly.co.id/app/ask?entry=hero&q=" + encodeURIComponent(question)

        brainly(question,batasan(BATAS,amount),function(x){

            if(x[0].success&&x[0].length<=0){
                //jika pertanyaanya tidak ada
                Virdina.replyMessage(`Keyword tidak ditemukan *"${x[0].q}"*\nGunakan keyword lain`)
            }else if(x[0].success==false){
                //jika error
                Virdina.replyMessage('cant access brainly now, try again later')
            }else{
            
                x[1].forEach(brainlyResult=>{
                    if(brainlyResult.jawaban.fotoJawaban.length==0){
                        pesan=""
                        pesan+="Pertanyaan‚ùì\n"
                        pesan+=brainlyResult.pertanyaan
                        pesan+="\n\nJawaban‚úÖ\n"
                        pesan+=brainlyResult.jawaban.judulJawaban
                        pesan+="\n"
                        Virdina.replyMessage(pesan)
                    }else{
                        let getExtention = /[^.]+$/.exec(brainlyResult.jawaban.fotoJawaban[0].trim());
                        let randomName = Virdina.generateTextRandom();
                        Virdina.downloadImage(brainlyResult.jawaban.fotoJawaban[0].trim(), `image/brainly${randomName}.${getExtention}`, () => {
                            let imgBase64 = fs.readFileSync(`image/brainly${randomName}.${getExtention}`, 'base64')
                            const media = new MessageMedia(`image/brainly${randomName}.${getExtention}`, imgBase64)
                            client.sendMessage(message.from, media, {
                                caption: `Pertanyaan‚ùì\n${brainlyResult.pertanyaan}\n\nJawaban‚úÖ\n${brainlyResult.jawaban.judulJawaban}`
                            })
                            console.log(`[INFO] download IMG ${randomName}.${getExtention} success`.yellow)
                        })
                    }
                })
                
            }

        })

    })

    Virdina.createCommand("math", function(msg, res) {
        if (typeof Math_js.evaluate(res) !== "number") {
            Virdina.replyMessage(`"${res}", bukan angka!`)
        } else {
            Virdina.replyMessage(`*Kalkulator*\n${res} = ${Math_js.evaluate(res)}`)
        }
    })

    Virdina.createCommand('help', function(msg, res) {
        pesan = ``
        pesan += `*Haiiiü§ñ üë©‚Äçüíª*\n*Menu*\n\nüí°Brainly Search\n/brainly <pertanyaan> -<jumlah>\n*/brainly rumus mtk -10*`
        pesan += `\n\n\nüí°Kalkulator\n_hanya bisa kali(*) bagi(/) tambah(+) kurang(-)_\n/math <angka>\n*/math 100+70/2*`
        pesan += "\n\n*Created by @virdiosam*"
        Virdina.replyMessage(pesan)
    })

})

client.initialize();


function batasan(amount, batas) {
    return Number(amount) >= batas ? batas : Number(amount)
}

//remove unwanted files
cron.schedule('10 * * * * *', () => {
    // Virdina.resetFolder("image");
    console.log(`===remove unwanted files===`.bgBlue);
    if (fs.existsSync('./debug.log')) {
        fs.unlinkSync('./debug.log')
    }
});
